<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HongShi‑DoH — UI</title>
  <link rel="icon" href="/favicon.png">
  <style>
    :root{--bg1:#ff8a00;--bg2:#ff5e62;--panel:rgba(255,255,255,.9);--border:rgba(255,255,255,.35);--muted:#555}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;display:grid;place-items:center}
    .card{width:980px;max-width:94vw;background:var(--panel);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 80px rgba(255,94,98,.25);padding:22px;margin:28px 0}
    header{display:flex;align-items:center;gap:14px;margin-bottom:10px}
    .avatar{width:48px;height:48px;border-radius:14px;border:1px solid var(--border);object-fit:cover}
    .sub{color:var(--muted);margin-bottom:12px}
    .row{display:grid;gap:10px}
    label{font-size:13px;color:var(--muted)}
    select,input{background:#fff;border:1px solid #e8e8e8;border-radius:12px;padding:12px 14px;outline:none}
    .pair{display:grid;grid-template-columns:1fr auto auto;gap:10px}
    .btn{border:0;border-radius:12px;font-weight:800;padding:12px 16px;cursor:pointer}
    .btn-main{background:#ff6a3d;color:#fff}
    .btn-sub{background:#eef3ff;color:#1a2b6c;border:1px solid #d9e4ff}
    .btn-clear{background:#fff1ef;color:#9a3a24;border:1px solid #ffd1c8}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .panel{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <img src="/favicon.png" class="avatar" alt="avatar"><div style="font-size:28px;font-weight:800">DNS‑over‑HTTPS Resolver</div>
    </header>
    <div class="sub">选择 DoH 端点并查询任意域名的解析结果。</div>

    <div class="row">
      <label>选择 DoH 地址：</label>
      <select id="doh">
        <option value="current">https://当前站点</option>
        <option value="https://cloudflare-dns.com/dns-query">Cloudflare — cloudflare-dns.com</option>
        <option value="https://dns.google/dns-query">Google — dns.google</option>
        <option value="custom">自定义…</option>
      </select>
      <input id="custom" placeholder="https://example.com/dns-query" style="display:none">
    </div>

    <div class="row" style="margin-top:8px">
      <label>待解析域名：</label>
      <div class="pair">
        <input id="name" placeholder="example.com" value="example.com">
        <select id="type">
          <option value="A">A</option><option value="AAAA">AAAA</option><option value="CNAME">CNAME</option>
          <option value="NS">NS</option><option value="MX">MX</option><option value="TXT">TXT</option>
        </select>
        <button id="btn" class="btn btn-main">解析</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr auto auto;gap:10px;margin:12px 0">
      <div></div>
      <button id="btnJson" class="btn btn-sub">Get JSON</button>
      <button id="btnClear" class="btn btn-clear">清除</button>
    </div>

    <div class="grid">
      <div class="panel">
        <div style="color:#555;margin-bottom:6px">简表</div>
        <div id="table">—</div>
      </div>
      <div class="panel">
        <div style="color:#555;margin-bottom:6px">原始 JSON</div>
        <pre id="raw">{}</pre>
      </div>
    </div>
  </div>

<script>
const $ = s=>document.querySelector(s);
const dohS=$('#doh'), customI=$('#custom'), nameI=$('#name'), typeS=$('#type');
const raw=$('#raw'), table=$('#table'), btn=$('#btn'), btnJson=$('#btnJson'), btnClear=$('#btnClear');

let meta = { dohPath: 'dns-query', dnsQueryEnabled: true };
async function loadMeta(){
  try{ const r=await fetch('/meta'); if(r.ok){ meta=await r.json(); } }catch{}
  if (meta.dohPath && meta.dohPath !== 'dns-query') {
    dohS.options[0].textContent = `https://当前站点（/${meta.dohPath}）`;
  } else {
    dohS.options[0].textContent = `https://当前站点（/dns-query）`;
  }
}
loadMeta();

dohS.addEventListener('change', ()=>{ customI.style.display = dohS.value==='custom' ? 'block':'none'; });

function dohEndpoint() {
  if (dohS.value==='current') {
    const path = (meta && meta.dohPath) ? meta.dohPath : 'dns-query';
    return location.origin + '/' + path;
  }
  if (dohS.value==='custom')  return customI.value.trim();
  return dohS.value;
}
function rrToString(a){ return a.data||a.ip||a.txt||a.target||a.value||(typeof a==='string'?a:JSON.stringify(a)); }
function renderTable(json){ const A=json.Answer||[]; if(!A.length){ table.innerHTML='—'; return; }
  const rows=A.map(a=>`<tr><td>${a.type||''}</td><td>${a.name||''}</td><td>${rrToString(a)}</td><td>${a.TTL||a.ttl||''}</td></tr>`).join('');
  table.innerHTML=`<table style="width:100%;border-collapse:collapse"><thead><tr><th>类型</th><th>名称</th><th>值</th><th>TTL</th></tr></thead><tbody>${rows}</tbody></table>`; }

async function query(doJson=false){
  const name=nameI.value.trim(); if(!name) return alert('请输入域名');
  const doh=dohEndpoint(); if(!doh) return alert('请填写自定义 DoH 地址');
  const base=doJson?(doh.replace('/dns-query','/resolve')):('/resolve'); const u=new URL(base, location.origin);
  u.searchParams.set('name', name); u.searchParams.set('type', typeS.value); if(!doJson) u.searchParams.set('doh', doh);
  const r=await fetch(u.toString()); const j=await r.json(); raw.textContent=JSON.stringify(j,null,2); renderTable(j);
}
btn.addEventListener('click', ()=>query(false));
btnJson.addEventListener('click', ()=>query(true));
btnClear.addEventListener('click', ()=>{ raw.textContent='{}'; table.innerHTML='—'; });
</script>
</body>
</html>
